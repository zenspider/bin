#!/usr/bin/ruby

name = `hostname -s`.chomp

extra = ARGV.dup
base = dirs = nil

flags  = ["-aCz"]
flags << "-vP" if $stdin.tty? and $stdout.tty?

case name
when "lust", "greed" then
  dirs = %w(Documents Work)
  base = File.expand_path "~"
when "envy" then
  dirs = %w(perforce www blogs)
  base = "/Users"
else
  abort "unknown machine #{name}"
end

Dir.chdir base

del = if extra.grep(/del/).empty? then
        "--del"
      else
        nil
      end

cmd = ["rsync", flags, del, extra,
       "--include", ".git",
       "--include", ".svn",
       "--exclude", "tmp",
       "--exclude", "pkg",
       "--exclude", "*.build",
       "--exclude", "backups",
       "--exclude", "gauntlet.noindex\*",
       # "--exclude", "logs",
       # "--exclude", "\*.noindex",
       "--exclude", "\*.ofocus-backup",
       dirs,
       "rsync:backups/#{name}"].flatten.compact

puts "starting rsync backup"
p cmd
system(*cmd) unless $n
puts "finished rsync backup"
