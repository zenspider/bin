#!/usr/bin/ruby -s

$n ||= false

name = `hostname -s`.chomp

if name == "YPCMC09457" then
  name = "lust"
  warn "atti sucks, renaming machine to #{name}"
end

extra = ARGV.dup
base = dirs = nil

flags  = ["-aCz"]
flags << "-vP" if $stdin.tty? and $stdout.tty?

case name
when "lust", "greed" then
  dirs = %w(Documents Work)
  base = File.expand_path "~"
when "envy" then
  dirs = %w(perforce www blogs)
  base = "/Users"
else
  abort "unknown machine #{name}"
end

Dir.chdir base

cmd = ["rsync", flags, "--del", extra,
       "--include", ".git",
       "--include", ".svn",
       "--exclude", "tmp",
       "--exclude", "pkg",
       "--exclude", "*.build",
       "--exclude", "\*.ofocus-backup",
       dirs,
       "rsync:backups/#{name}"].flatten

puts "starting rsync backup"
p cmd
system(*cmd) unless $n
puts "finished rsync backup"
